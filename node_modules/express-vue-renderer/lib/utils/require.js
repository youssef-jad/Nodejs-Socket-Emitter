'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Module = require('module');
var path = require('path');
var Utils = require('./index');
var Renderer = require('../renderer');
var Models = require('../models');

var Options = function Options(optsObj) {
    _classCallCheck(this, Options);

    this.vueFileRegex = /([\w/.\-@_\d]*\.vue)/igm;
    this.requireRegex = /(require\(['"])([\w/.\-@_\d]*\.vue)(['"]\))/igm;
    this.appendPaths = optsObj.appendPaths || [];
    this.prependPaths = optsObj.prependPaths || [];
    this.rootPath = optsObj.rootPath || '';
    this.defaults = optsObj.defaults;
};

function getVueObject(componentPath, rootPath, vueComponentFileMatch, Cache, Options) {
    var GlobalOptions = new Models.Defaults({
        rootPath: rootPath,
        component: componentPath,
        style: Options.defaults.style || ''
    });
    return new Promise(function (resolve, reject) {
        Utils.setupComponent(componentPath, GlobalOptions, Cache).then(function (component) {
            var rendered = Renderer.renderHtmlUtil(component);
            if (!rendered) {
                reject(new Error('Renderer Error'));
            } else {
                if (Options.defaults.style) {
                    Options.defaults.style += rendered.layout.style;
                } else {
                    Options.defaults.style = rendered.layout.style;
                }

                resolve({
                    rendered: rendered,
                    match: vueComponentFileMatch
                });
            }
        }).catch(function (error) {
            reject(error);
        });
    });
}

function replaceRelativePaths(code, rootPath) {
    var parentMatchesSingle = code.match(/(require\('\.\.\/)/gm);
    var currentMatchesSingle = code.match(/(require\('\.\/)/gm);
    var parentMatchesDouble = code.match(/(require\("\.\.\/)/gm);
    var currentMatchesDouble = code.match(/(require\("\.\/)/gm);
    if (parentMatchesSingle) {
        var _iteratorNormalCompletion = true;
        var _didIteratorError = false;
        var _iteratorError = undefined;

        try {
            for (var _iterator = parentMatchesSingle[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                var _match = _step.value;

                code = code.replace(_match, 'require(\'' + rootPath + '/../');
            }
        } catch (err) {
            _didIteratorError = true;
            _iteratorError = err;
        } finally {
            try {
                if (!_iteratorNormalCompletion && _iterator.return) {
                    _iterator.return();
                }
            } finally {
                if (_didIteratorError) {
                    throw _iteratorError;
                }
            }
        }
    }
    if (parentMatchesDouble) {
        var _iteratorNormalCompletion2 = true;
        var _didIteratorError2 = false;
        var _iteratorError2 = undefined;

        try {
            for (var _iterator2 = parentMatchesDouble[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
                var _match2 = _step2.value;

                code = code.replace(_match2, 'require("' + rootPath + '/../');
            }
        } catch (err) {
            _didIteratorError2 = true;
            _iteratorError2 = err;
        } finally {
            try {
                if (!_iteratorNormalCompletion2 && _iterator2.return) {
                    _iterator2.return();
                }
            } finally {
                if (_didIteratorError2) {
                    throw _iteratorError2;
                }
            }
        }
    }
    if (currentMatchesSingle) {
        var _iteratorNormalCompletion3 = true;
        var _didIteratorError3 = false;
        var _iteratorError3 = undefined;

        try {
            for (var _iterator3 = currentMatchesSingle[Symbol.iterator](), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
                var _match3 = _step3.value;

                code = code.replace(_match3, 'require(\'' + rootPath + '/./');
            }
        } catch (err) {
            _didIteratorError3 = true;
            _iteratorError3 = err;
        } finally {
            try {
                if (!_iteratorNormalCompletion3 && _iterator3.return) {
                    _iterator3.return();
                }
            } finally {
                if (_didIteratorError3) {
                    throw _iteratorError3;
                }
            }
        }
    }
    if (currentMatchesDouble) {
        var _iteratorNormalCompletion4 = true;
        var _didIteratorError4 = false;
        var _iteratorError4 = undefined;

        try {
            for (var _iterator4 = currentMatchesDouble[Symbol.iterator](), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
                var _match4 = _step4.value;

                code = code.replace(_match4, 'require("' + rootPath + '/./');
            }
        } catch (err) {
            _didIteratorError4 = true;
            _iteratorError4 = err;
        } finally {
            try {
                if (!_iteratorNormalCompletion4 && _iterator4.return) {
                    _iterator4.return();
                }
            } finally {
                if (_didIteratorError4) {
                    throw _iteratorError4;
                }
            }
        }
    }

    return code;
}

function requireFromString(code) {
    var filename = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';
    var optsObj = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};
    var Cache = arguments[3];

    return new Promise(function (resolve, reject) {
        var options = new Options(optsObj);
        var promiseArray = [];

        if (typeof code !== 'string') {
            throw new Error('code must be a string, not ' + (typeof code === 'undefined' ? 'undefined' : _typeof(code)));
        }
        code = replaceRelativePaths(code, options.rootPath);
        var paths = Module._nodeModulePaths(path.dirname(filename));
        var m = new Module(filename, options.rootPath);
        m.filename = filename;
        m.paths = [].concat(options.prependPaths).concat(paths).concat(options.appendPaths);

        //find matches for the require paths
        var vueComponentFileMatches = code.match(options.requireRegex);
        if (vueComponentFileMatches && vueComponentFileMatches.length > 0) {
            //iterate through the matches
            for (var index = 0; index < vueComponentFileMatches.length; index++) {
                var vueComponentFileMatch = vueComponentFileMatches[index];
                //get the file out of the require string
                //this is because its easier to do string replace later
                var vueComponentFile = vueComponentFileMatch.match(options.vueFileRegex);
                if (vueComponentFile && vueComponentFile.length > 0) {
                    promiseArray.push(getVueObject(vueComponentFile[0], options.rootPath, vueComponentFileMatch, Cache, options));
                }
            }
            Promise.all(promiseArray).then(function (renderedItemArray) {
                var styles = '';
                var _iteratorNormalCompletion5 = true;
                var _didIteratorError5 = false;
                var _iteratorError5 = undefined;

                try {
                    for (var _iterator5 = renderedItemArray[Symbol.iterator](), _step5; !(_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done); _iteratorNormalCompletion5 = true) {
                        var renderedItem = _step5.value;

                        var rawString = renderedItem.rendered.scriptStringRaw;
                        code = code.replace(renderedItem.match, rawString);
                        if (renderedItem.rendered.layout && renderedItem.rendered.layout.style) {
                            styles += renderedItem.rendered.layout.style;
                        }
                    }
                    //check if its the last element and then render
                } catch (err) {
                    _didIteratorError5 = true;
                    _iteratorError5 = err;
                } finally {
                    try {
                        if (!_iteratorNormalCompletion5 && _iterator5.return) {
                            _iterator5.return();
                        }
                    } finally {
                        if (_didIteratorError5) {
                            throw _iteratorError5;
                        }
                    }
                }

                var last_element = code.match(options.vueFileRegex);
                if (last_element === undefined || last_element === null) {
                    m._compile(code, filename);
                    m.exports.default.styles = styles;
                    resolve(m.exports.default);
                }
            }).catch(function (error) {
                reject(error);
            });
        } else {
            m._compile(code, filename);
            resolve(m.exports.default);
        }
    });
}

module.exports = requireFromString;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9yZXF1aXJlLmpzIl0sIm5hbWVzIjpbIk1vZHVsZSIsInJlcXVpcmUiLCJwYXRoIiwiVXRpbHMiLCJSZW5kZXJlciIsIk1vZGVscyIsIk9wdGlvbnMiLCJvcHRzT2JqIiwidnVlRmlsZVJlZ2V4IiwicmVxdWlyZVJlZ2V4IiwiYXBwZW5kUGF0aHMiLCJwcmVwZW5kUGF0aHMiLCJyb290UGF0aCIsImRlZmF1bHRzIiwiZ2V0VnVlT2JqZWN0IiwiY29tcG9uZW50UGF0aCIsInZ1ZUNvbXBvbmVudEZpbGVNYXRjaCIsIkNhY2hlIiwiR2xvYmFsT3B0aW9ucyIsIkRlZmF1bHRzIiwiY29tcG9uZW50Iiwic3R5bGUiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInNldHVwQ29tcG9uZW50IiwidGhlbiIsInJlbmRlcmVkIiwicmVuZGVySHRtbFV0aWwiLCJFcnJvciIsImxheW91dCIsIm1hdGNoIiwiY2F0Y2giLCJlcnJvciIsInJlcGxhY2VSZWxhdGl2ZVBhdGhzIiwiY29kZSIsInBhcmVudE1hdGNoZXNTaW5nbGUiLCJjdXJyZW50TWF0Y2hlc1NpbmdsZSIsInBhcmVudE1hdGNoZXNEb3VibGUiLCJjdXJyZW50TWF0Y2hlc0RvdWJsZSIsInJlcGxhY2UiLCJyZXF1aXJlRnJvbVN0cmluZyIsImZpbGVuYW1lIiwib3B0aW9ucyIsInByb21pc2VBcnJheSIsInBhdGhzIiwiX25vZGVNb2R1bGVQYXRocyIsImRpcm5hbWUiLCJtIiwiY29uY2F0IiwidnVlQ29tcG9uZW50RmlsZU1hdGNoZXMiLCJsZW5ndGgiLCJpbmRleCIsInZ1ZUNvbXBvbmVudEZpbGUiLCJwdXNoIiwiYWxsIiwic3R5bGVzIiwicmVuZGVyZWRJdGVtQXJyYXkiLCJyZW5kZXJlZEl0ZW0iLCJyYXdTdHJpbmciLCJzY3JpcHRTdHJpbmdSYXciLCJsYXN0X2VsZW1lbnQiLCJ1bmRlZmluZWQiLCJfY29tcGlsZSIsImV4cG9ydHMiLCJkZWZhdWx0IiwibW9kdWxl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Q0hlLGNBQUVlLFFBQUYsQ0FBVzVCLElBQVgsRUFBaUJPLFFBQWpCO0FBQ0FuQixvQkFBUXlCLEVBQUVnQixPQUFGLENBQVVDLE9BQWxCO0FBQ0g7QUFDSixLQW5ETSxDQUFQO0FBb0RIOztBQUVEQyxPQUFPRixPQUFQLEdBQWlCdkIsaUJBQWpCIiwiZmlsZSI6InJlcXVpcmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuY29uc3QgTW9kdWxlID0gcmVxdWlyZSgnbW9kdWxlJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgVXRpbHMgPSByZXF1aXJlKCcuL2luZGV4Jyk7XG5jb25zdCBSZW5kZXJlciA9IHJlcXVpcmUoJy4uL3JlbmRlcmVyJyk7XG5jb25zdCBNb2RlbHMgPSByZXF1aXJlKCcuLi9tb2RlbHMnKTtcblxuY2xhc3MgT3B0aW9ucyB7XG4gICAgdnVlRmlsZVJlZ2V4OiBSZWdFeHA7XG4gICAgcmVxdWlyZVJlZ2V4OiBSZWdFeHA7XG4gICAgYXBwZW5kUGF0aHM6IHN0cmluZ1tdO1xuICAgIHByZXBlbmRQYXRoczogc3RyaW5nW107XG4gICAgcm9vdFBhdGg6IHN0cmluZztcbiAgICBkZWZhdWx0czogTW9kZWxzLkRlZmF1bHRzO1xuICAgIGNvbnN0cnVjdG9yKG9wdHNPYmo6IE9iamVjdCkge1xuICAgICAgICB0aGlzLnZ1ZUZpbGVSZWdleCA9IC8oW1xcdy8uXFwtQF9cXGRdKlxcLnZ1ZSkvaWdtO1xuICAgICAgICB0aGlzLnJlcXVpcmVSZWdleCA9IC8ocmVxdWlyZVxcKFsnXCJdKShbXFx3Ly5cXC1AX1xcZF0qXFwudnVlKShbJ1wiXVxcKSkvaWdtO1xuICAgICAgICB0aGlzLmFwcGVuZFBhdGhzID0gb3B0c09iai5hcHBlbmRQYXRocyB8fCBbXTtcbiAgICAgICAgdGhpcy5wcmVwZW5kUGF0aHMgPSBvcHRzT2JqLnByZXBlbmRQYXRocyB8fCBbXTtcbiAgICAgICAgdGhpcy5yb290UGF0aCA9IG9wdHNPYmoucm9vdFBhdGggfHwgJyc7XG4gICAgICAgIHRoaXMuZGVmYXVsdHMgPSBvcHRzT2JqLmRlZmF1bHRzO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gZ2V0VnVlT2JqZWN0KGNvbXBvbmVudFBhdGg6IHN0cmluZywgcm9vdFBhdGg6IHN0cmluZywgdnVlQ29tcG9uZW50RmlsZU1hdGNoOiBzdHJpbmcsIENhY2hlOiBPYmplY3QsIE9wdGlvbnM6IE9wdGlvbnMpOiBQcm9taXNlIDwge3JlbmRlcmVkOk9iamVjdCwgbWF0Y2g6IHN0cmluZ30gPiB7XG4gICAgY29uc3QgR2xvYmFsT3B0aW9ucyA9IG5ldyBNb2RlbHMuRGVmYXVsdHMoe1xuICAgICAgICByb290UGF0aDogcm9vdFBhdGgsXG4gICAgICAgIGNvbXBvbmVudDogY29tcG9uZW50UGF0aCxcbiAgICAgICAgc3R5bGU6IE9wdGlvbnMuZGVmYXVsdHMuc3R5bGUgfHwgJydcbiAgICB9KTtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBVdGlscy5zZXR1cENvbXBvbmVudChjb21wb25lbnRQYXRoLCBHbG9iYWxPcHRpb25zLCBDYWNoZSlcbiAgICAgICAgICAgIC50aGVuKGNvbXBvbmVudCA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVuZGVyZWQgPSBSZW5kZXJlci5yZW5kZXJIdG1sVXRpbChjb21wb25lbnQpO1xuICAgICAgICAgICAgICAgIGlmICghcmVuZGVyZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignUmVuZGVyZXIgRXJyb3InKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKE9wdGlvbnMuZGVmYXVsdHMuc3R5bGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIE9wdGlvbnMuZGVmYXVsdHMuc3R5bGUgKz0gcmVuZGVyZWQubGF5b3V0LnN0eWxlO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgT3B0aW9ucy5kZWZhdWx0cy5zdHlsZSA9IHJlbmRlcmVkLmxheW91dC5zdHlsZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVuZGVyZWQ6IHJlbmRlcmVkLFxuICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2g6IHZ1ZUNvbXBvbmVudEZpbGVNYXRjaFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KS5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgfSk7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlcGxhY2VSZWxhdGl2ZVBhdGhzKGNvZGU6IHN0cmluZywgcm9vdFBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgcGFyZW50TWF0Y2hlc1NpbmdsZSA9IGNvZGUubWF0Y2goLyhyZXF1aXJlXFwoJ1xcLlxcLlxcLykvZ20pO1xuICAgIGNvbnN0IGN1cnJlbnRNYXRjaGVzU2luZ2xlID0gY29kZS5tYXRjaCgvKHJlcXVpcmVcXCgnXFwuXFwvKS9nbSk7XG4gICAgY29uc3QgcGFyZW50TWF0Y2hlc0RvdWJsZSA9IGNvZGUubWF0Y2goLyhyZXF1aXJlXFwoXCJcXC5cXC5cXC8pL2dtKTtcbiAgICBjb25zdCBjdXJyZW50TWF0Y2hlc0RvdWJsZSA9IGNvZGUubWF0Y2goLyhyZXF1aXJlXFwoXCJcXC5cXC8pL2dtKTtcbiAgICBpZiAocGFyZW50TWF0Y2hlc1NpbmdsZSkge1xuICAgICAgICBmb3IgKGNvbnN0IG1hdGNoIG9mIHBhcmVudE1hdGNoZXNTaW5nbGUpIHtcbiAgICAgICAgICAgIGNvZGUgPSBjb2RlLnJlcGxhY2UobWF0Y2gsIGByZXF1aXJlKCcke3Jvb3RQYXRofS8uLi9gKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAocGFyZW50TWF0Y2hlc0RvdWJsZSkge1xuICAgICAgICBmb3IgKGNvbnN0IG1hdGNoIG9mIHBhcmVudE1hdGNoZXNEb3VibGUpIHtcbiAgICAgICAgICAgIGNvZGUgPSBjb2RlLnJlcGxhY2UobWF0Y2gsIGByZXF1aXJlKFwiJHtyb290UGF0aH0vLi4vYCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGN1cnJlbnRNYXRjaGVzU2luZ2xlKSB7XG4gICAgICAgIGZvciAoY29uc3QgbWF0Y2ggb2YgY3VycmVudE1hdGNoZXNTaW5nbGUpIHtcbiAgICAgICAgICAgIGNvZGUgPSBjb2RlLnJlcGxhY2UobWF0Y2gsIGByZXF1aXJlKCcke3Jvb3RQYXRofS8uL2ApO1xuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChjdXJyZW50TWF0Y2hlc0RvdWJsZSkge1xuICAgICAgICBmb3IgKGNvbnN0IG1hdGNoIG9mIGN1cnJlbnRNYXRjaGVzRG91YmxlKSB7XG4gICAgICAgICAgICBjb2RlID0gY29kZS5yZXBsYWNlKG1hdGNoLCBgcmVxdWlyZShcIiR7cm9vdFBhdGh9Ly4vYCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gY29kZTtcbn1cblxuXG5mdW5jdGlvbiByZXF1aXJlRnJvbVN0cmluZyhjb2RlOiBzdHJpbmcsIGZpbGVuYW1lOiBzdHJpbmcgPSAnJywgb3B0c09iajogT2JqZWN0ID0ge30sIENhY2hlOiBPYmplY3QpOiBQcm9taXNlIDwgT2JqZWN0ID4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGNvbnN0IG9wdGlvbnMgPSBuZXcgT3B0aW9ucyhvcHRzT2JqKTtcbiAgICAgICAgbGV0IHByb21pc2VBcnJheSA9IFtdO1xuXG4gICAgICAgIGlmICh0eXBlb2YgY29kZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignY29kZSBtdXN0IGJlIGEgc3RyaW5nLCBub3QgJyArIHR5cGVvZiBjb2RlKTtcbiAgICAgICAgfVxuICAgICAgICBjb2RlID0gcmVwbGFjZVJlbGF0aXZlUGF0aHMoY29kZSwgb3B0aW9ucy5yb290UGF0aCk7XG4gICAgICAgIGxldCBwYXRocyA9IE1vZHVsZS5fbm9kZU1vZHVsZVBhdGhzKHBhdGguZGlybmFtZShmaWxlbmFtZSkpO1xuICAgICAgICB2YXIgbSA9IG5ldyBNb2R1bGUoZmlsZW5hbWUsIG9wdGlvbnMucm9vdFBhdGgpO1xuICAgICAgICBtLmZpbGVuYW1lID0gZmlsZW5hbWU7XG4gICAgICAgIG0ucGF0aHMgPSBbXS5jb25jYXQob3B0aW9ucy5wcmVwZW5kUGF0aHMpLmNvbmNhdChwYXRocykuY29uY2F0KG9wdGlvbnMuYXBwZW5kUGF0aHMpO1xuXG4gICAgICAgIC8vZmluZCBtYXRjaGVzIGZvciB0aGUgcmVxdWlyZSBwYXRoc1xuICAgICAgICBsZXQgdnVlQ29tcG9uZW50RmlsZU1hdGNoZXMgPSBjb2RlLm1hdGNoKG9wdGlvbnMucmVxdWlyZVJlZ2V4KTtcbiAgICAgICAgaWYgKHZ1ZUNvbXBvbmVudEZpbGVNYXRjaGVzICYmIHZ1ZUNvbXBvbmVudEZpbGVNYXRjaGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIC8vaXRlcmF0ZSB0aHJvdWdoIHRoZSBtYXRjaGVzXG4gICAgICAgICAgICBmb3IgKHZhciBpbmRleCA9IDA7IGluZGV4IDwgdnVlQ29tcG9uZW50RmlsZU1hdGNoZXMubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgICAgICAgICAgdmFyIHZ1ZUNvbXBvbmVudEZpbGVNYXRjaCA9IHZ1ZUNvbXBvbmVudEZpbGVNYXRjaGVzW2luZGV4XTtcbiAgICAgICAgICAgICAgICAvL2dldCB0aGUgZmlsZSBvdXQgb2YgdGhlIHJlcXVpcmUgc3RyaW5nXG4gICAgICAgICAgICAgICAgLy90aGlzIGlzIGJlY2F1c2UgaXRzIGVhc2llciB0byBkbyBzdHJpbmcgcmVwbGFjZSBsYXRlclxuICAgICAgICAgICAgICAgIGNvbnN0IHZ1ZUNvbXBvbmVudEZpbGUgPSB2dWVDb21wb25lbnRGaWxlTWF0Y2gubWF0Y2gob3B0aW9ucy52dWVGaWxlUmVnZXgpO1xuICAgICAgICAgICAgICAgIGlmICh2dWVDb21wb25lbnRGaWxlICYmIHZ1ZUNvbXBvbmVudEZpbGUubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBwcm9taXNlQXJyYXkucHVzaChnZXRWdWVPYmplY3QodnVlQ29tcG9uZW50RmlsZVswXSwgb3B0aW9ucy5yb290UGF0aCwgdnVlQ29tcG9uZW50RmlsZU1hdGNoLCBDYWNoZSwgb3B0aW9ucykpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFByb21pc2UuYWxsKHByb21pc2VBcnJheSlcbiAgICAgICAgICAgICAgICAudGhlbihyZW5kZXJlZEl0ZW1BcnJheSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzdHlsZXMgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgcmVuZGVyZWRJdGVtIG9mIHJlbmRlcmVkSXRlbUFycmF5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByYXdTdHJpbmcgPSByZW5kZXJlZEl0ZW0ucmVuZGVyZWQuc2NyaXB0U3RyaW5nUmF3O1xuICAgICAgICAgICAgICAgICAgICAgICAgY29kZSA9IGNvZGUucmVwbGFjZShyZW5kZXJlZEl0ZW0ubWF0Y2gsIHJhd1N0cmluZyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVuZGVyZWRJdGVtLnJlbmRlcmVkLmxheW91dCAmJiByZW5kZXJlZEl0ZW0ucmVuZGVyZWQubGF5b3V0LnN0eWxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGVzICs9IHJlbmRlcmVkSXRlbS5yZW5kZXJlZC5sYXlvdXQuc3R5bGU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy9jaGVjayBpZiBpdHMgdGhlIGxhc3QgZWxlbWVudCBhbmQgdGhlbiByZW5kZXJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFzdF9lbGVtZW50ID0gY29kZS5tYXRjaChvcHRpb25zLnZ1ZUZpbGVSZWdleCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChsYXN0X2VsZW1lbnQgPT09IHVuZGVmaW5lZCB8fCBsYXN0X2VsZW1lbnQgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG0uX2NvbXBpbGUoY29kZSwgZmlsZW5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbS5leHBvcnRzLmRlZmF1bHQuc3R5bGVzID0gc3R5bGVzO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShtLmV4cG9ydHMuZGVmYXVsdCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5jYXRjaChlcnJvciA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBtLl9jb21waWxlKGNvZGUsIGZpbGVuYW1lKTtcbiAgICAgICAgICAgIHJlc29sdmUobS5leHBvcnRzLmRlZmF1bHQpO1xuICAgICAgICB9XG4gICAgfSk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gcmVxdWlyZUZyb21TdHJpbmc7XG4iXX0=