'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Models = require('./models');
var LRU = require('lru-cache');
var path = require('path');
var Utils = require('./utils');
var Renderer = require('./renderer');
var vueServerRenderer = require('vue-server-renderer').createRenderer();

var cacheOptions = {
    max: 500,
    maxAge: 1000 * 60 * 60
};
var lruCache = LRU(cacheOptions);

/**
 * ExpressVueRenderer Class is the main init Class
 * init with `new ExpressVueRenderer(options)`
 * returns the ExpressVueRenderer class
 * @class
 */

var ExpressVueRenderer = function () {
    /**
     * ExpressVueRenderer constructor
     * @constructor
     * @param {Object} options - The options passed to init the class
     */
    function ExpressVueRenderer(options) {
        _classCallCheck(this, ExpressVueRenderer);

        this.GlobalOptions = new Models.Defaults(options);
        this.Cache = lruCache;
    }
    /**
     * createAppObject is an internal function used by renderToStream
     * @param  {string} componentPath - full path to .vue file
     * @param  {Object} data          - data to be inserted when generating vue class
     * @param  {Object} vueOptions    - vue options to be used when generating head
     * @return {Promise}              - Promise consists of an AppClass Object
     */


    _createClass(ExpressVueRenderer, [{
        key: 'createAppObject',
        value: function createAppObject(componentPath, data, vueOptions) {
            var _this = this;

            return new Promise(function (resolve, reject) {
                var Options = Object.create(_this.GlobalOptions);
                Options.data = Models.Defaults.mergeObjects(Options.data, data);
                // Options.mergeDataObject(data);
                if (vueOptions) {
                    Options.vue = Models.Defaults.mergeObjects(Options.vue, vueOptions);
                }
                Options.component = componentPath;

                Utils.setupComponent(path.join(Options.rootPath, componentPath), Options, _this.Cache).then(function (component) {

                    var rendered = Renderer.renderHtmlUtil(component);
                    if (!rendered) {
                        reject(new Error('Renderer Error'));
                    } else {
                        var VueClass = rendered.app;
                        var template = Options.layout;
                        var script = rendered.scriptString;
                        var head = new Utils.HeadUtils(Options.vue, rendered.layout.style);

                        var app = new Models.AppClass(VueClass, template, script, head.toString());
                        resolve(app);
                    }
                }).catch(function (error) {
                    reject(error);
                });
            });
        }
        /**
         * renderToStream is the main function used by res.renderVue
         * @param {string} componentPath - full path to .vue component
         * @param  {Object} data          - data to be inserted when generating vue class
         * @param  {Object} vueOptions    - vue options to be used when generating head
         * @return {Promise}              - Promise returns a Stream
         */

    }, {
        key: 'renderToStream',
        value: function renderToStream(componentPath, data, vueOptions) {
            var _this2 = this;

            return new Promise(function (resolve, reject) {
                _this2.createAppObject(componentPath, data, vueOptions).then(function (app) {
                    var vueStream = vueServerRenderer.renderToStream(app.VueClass);
                    var htmlStream = void 0;
                    var htmlStringStart = '' + app.template.html.start + app.head + app.template.body.start + app.template.template.start;
                    var htmlStringEnd = '' + app.template.template.end + app.script + app.template.body.end + app.template.html.end;

                    htmlStream = new Utils.StreamUtils(htmlStringStart, htmlStringEnd);
                    htmlStream = vueStream.pipe(htmlStream);

                    resolve(htmlStream);
                }).catch(function (error) {
                    reject(error);
                });
            });
        }
    }]);

    return ExpressVueRenderer;
}();

module.exports = ExpressVueRenderer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJNb2RlbHMiLCJyZXF1aXJlIiwiTFJVIiwicGF0aCIsIlV0aWxzIiwiUmVuZGVyZXIiLCJ2dWVTZXJ2ZXJSZW5kZXJlciIsImNyZWF0ZVJlbmRlcmVyIiwiY2FjaGVPcHRpb25zIiwibWF4IiwibWF4QWdlIiwibHJ1Q2FjaGUiLCJFeHByZXNzVnVlUmVuZGVyZXIiLCJvcHRpb25zIiwiR2xvYmFsT3B0aW9ucyIsIkRlZmF1bHRzIiwiQ2FjaGUiLCJjb21wb25lbnRQYXRoIiwiZGF0YSIsInZ1ZU9wdGlvbnMiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsIk9wdGlvbnMiLCJPYmplY3QiLCJjcmVhdGUiLCJtZXJnZU9iamVjdHMiLCJ2dWUiLCJjb21wb25lbnQiLCJzZXR1cENvbXBvbmVudCIsImpvaW4iLCJyb290UGF0aCIsInRoZW4iLCJyZW5kZXJlZCIsInJlbmRlckh0bWxVdGlsIiwiRXJyb3IiLCJWdWVDbGFzcyIsImFwcCIsInRlbXBsYXRlIiwibGF5b3V0Iiwic2NyaXB0Iiwic2NyaXB0U3RyaW5nIiwiaGVhZCIsIkhlYWRVdGlscyIsInN0eWxlIiwiQXBwQ2xhc3MiLCJ0b1N0cmluZyIsImNhdGNoIiwiZXJyb3IiLCJjcmVhdGVBcHBPYmplY3QiLCJ2dWVTdHJlYW0iLCJyZW5kZXJUb1N0cmVhbSIsImh0bWxTdHJlYW0iLCJodG1sU3RyaW5nU3RhcnQiLCJodG1sIiwic3RhcnQiLCJib2R5IiwiaHRtbFN0cmluZ0VuZCIsImVuZCIsIlN0cmVhbVV0aWxzIiwicGlwZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUNBOzs7Ozs7QUFDQSxJQUFNQSxTQUFTQyxRQUFRLFVBQVIsQ0FBZjtBQUNBLElBQU1DLE1BQU1ELFFBQVEsV0FBUixDQUFaO0FBQ0EsSUFBTUUsT0FBT0YsUUFBUSxNQUFSLENBQWI7QUFDQSxJQUFNRyxRQUFRSCxRQUFRLFNBQVIsQ0FBZDtBQUNBLElBQU1J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LEdBQW9GbEIsSUFBSUMsUUFBSixDQUFhQSxRQUFiLENBQXNCaUIsS0FBaEg7QUFDQSx3QkFBTUUscUJBQW1CcEIsSUFBSUMsUUFBSixDQUFhQSxRQUFiLENBQXNCb0IsR0FBekMsR0FBK0NyQixJQUFJRyxNQUFuRCxHQUE0REgsSUFBSUMsUUFBSixDQUFha0IsSUFBYixDQUFrQkUsR0FBOUUsR0FBb0ZyQixJQUFJQyxRQUFKLENBQWFnQixJQUFiLENBQWtCSSxHQUE1Rzs7QUFFQU4saUNBQWEsSUFBSWhELE1BQU11RCxXQUFWLENBQXNCTixlQUF0QixFQUF1Q0ksYUFBdkMsQ0FBYjtBQUNBTCxpQ0FBYUYsVUFBVVUsSUFBVixDQUFlUixVQUFmLENBQWI7O0FBRUEvQiw0QkFBUStCLFVBQVI7QUFDSCxpQkFYTCxFQVdPTCxLQVhQLENBV2EsaUJBQVM7QUFDZHpCLDJCQUFPMEIsS0FBUDtBQUNILGlCQWJMO0FBY0gsYUFmTSxDQUFQO0FBZ0JIOzs7Ozs7QUFHTGEsT0FBT0MsT0FBUCxHQUFpQmxELGtCQUFqQiIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG4ndXNlIHN0cmljdCc7XG5jb25zdCBNb2RlbHMgPSByZXF1aXJlKCcuL21vZGVscycpO1xuY29uc3QgTFJVID0gcmVxdWlyZSgnbHJ1LWNhY2hlJyk7XG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgVXRpbHMgPSByZXF1aXJlKCcuL3V0aWxzJyk7XG5jb25zdCBSZW5kZXJlciA9IHJlcXVpcmUoJy4vcmVuZGVyZXInKTtcbmNvbnN0IHZ1ZVNlcnZlclJlbmRlcmVyID0gcmVxdWlyZSgndnVlLXNlcnZlci1yZW5kZXJlcicpLmNyZWF0ZVJlbmRlcmVyKCk7XG5cbmNvbnN0IGNhY2hlT3B0aW9ucyA9IHtcbiAgICBtYXg6IDUwMCxcbiAgICBtYXhBZ2U6IDEwMDAgKiA2MCAqIDYwXG59O1xuY29uc3QgbHJ1Q2FjaGUgPSBMUlUoY2FjaGVPcHRpb25zKTtcblxuXG4vKipcbiAqIEV4cHJlc3NWdWVSZW5kZXJlciBDbGFzcyBpcyB0aGUgbWFpbiBpbml0IENsYXNzXG4gKiBpbml0IHdpdGggYG5ldyBFeHByZXNzVnVlUmVuZGVyZXIob3B0aW9ucylgXG4gKiByZXR1cm5zIHRoZSBFeHByZXNzVnVlUmVuZGVyZXIgY2xhc3NcbiAqIEBjbGFzc1xuICovXG5jbGFzcyBFeHByZXNzVnVlUmVuZGVyZXIge1xuICAgIEdsb2JhbE9wdGlvbnM6IE1vZGVscy5EZWZhdWx0cztcbiAgICBDYWNoZTogTFJVO1xuICAgIC8qKlxuICAgICAqIEV4cHJlc3NWdWVSZW5kZXJlciBjb25zdHJ1Y3RvclxuICAgICAqIEBjb25zdHJ1Y3RvclxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIC0gVGhlIG9wdGlvbnMgcGFzc2VkIHRvIGluaXQgdGhlIGNsYXNzXG4gICAgICovXG4gICAgY29uc3RydWN0b3Iob3B0aW9uczogT2JqZWN0KSB7XG4gICAgICAgIHRoaXMuR2xvYmFsT3B0aW9ucyA9IG5ldyBNb2RlbHMuRGVmYXVsdHMob3B0aW9ucyk7XG4gICAgICAgIHRoaXMuQ2FjaGUgPSBscnVDYWNoZTtcbiAgICB9XG4gICAgLyoqXG4gICAgICogY3JlYXRlQXBwT2JqZWN0IGlzIGFuIGludGVybmFsIGZ1bmN0aW9uIHVzZWQgYnkgcmVuZGVyVG9TdHJlYW1cbiAgICAgKiBAcGFyYW0gIHtzdHJpbmd9IGNvbXBvbmVudFBhdGggLSBmdWxsIHBhdGggdG8gLnZ1ZSBmaWxlXG4gICAgICogQHBhcmFtICB7T2JqZWN0fSBkYXRhICAgICAgICAgIC0gZGF0YSB0byBiZSBpbnNlcnRlZCB3aGVuIGdlbmVyYXRpbmcgdnVlIGNsYXNzXG4gICAgICogQHBhcmFtICB7T2JqZWN0fSB2dWVPcHRpb25zICAgIC0gdnVlIG9wdGlvbnMgdG8gYmUgdXNlZCB3aGVuIGdlbmVyYXRpbmcgaGVhZFxuICAgICAqIEByZXR1cm4ge1Byb21pc2V9ICAgICAgICAgICAgICAtIFByb21pc2UgY29uc2lzdHMgb2YgYW4gQXBwQ2xhc3MgT2JqZWN0XG4gICAgICovXG4gICAgY3JlYXRlQXBwT2JqZWN0KGNvbXBvbmVudFBhdGg6IHN0cmluZywgZGF0YTogT2JqZWN0LCB2dWVPcHRpb25zOiA/IE9iamVjdCk6IFByb21pc2UgPCBNb2RlbHMuQXBwQ2xhc3MgPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBsZXQgT3B0aW9ucyA9IE9iamVjdC5jcmVhdGUodGhpcy5HbG9iYWxPcHRpb25zKTtcbiAgICAgICAgICAgIE9wdGlvbnMuZGF0YSA9IE1vZGVscy5EZWZhdWx0cy5tZXJnZU9iamVjdHMoT3B0aW9ucy5kYXRhLCBkYXRhKTtcbiAgICAgICAgICAgIC8vIE9wdGlvbnMubWVyZ2VEYXRhT2JqZWN0KGRhdGEpO1xuICAgICAgICAgICAgaWYgKHZ1ZU9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBPcHRpb25zLnZ1ZSA9IE1vZGVscy5EZWZhdWx0cy5tZXJnZU9iamVjdHMoT3B0aW9ucy52dWUsIHZ1ZU9wdGlvbnMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgT3B0aW9ucy5jb21wb25lbnQgPSBjb21wb25lbnRQYXRoO1xuXG4gICAgICAgICAgICBVdGlscy5zZXR1cENvbXBvbmVudChwYXRoLmpvaW4oT3B0aW9ucy5yb290UGF0aCwgY29tcG9uZW50UGF0aCksIE9wdGlvbnMsIHRoaXMuQ2FjaGUpXG4gICAgICAgICAgICAgICAgLnRoZW4oKGNvbXBvbmVudCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlbmRlcmVkID0gUmVuZGVyZXIucmVuZGVySHRtbFV0aWwoY29tcG9uZW50KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZW5kZXJlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcignUmVuZGVyZXIgRXJyb3InKSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBWdWVDbGFzcyA9IHJlbmRlcmVkLmFwcDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRlbXBsYXRlID0gT3B0aW9ucy5sYXlvdXQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzY3JpcHQgPSByZW5kZXJlZC5zY3JpcHRTdHJpbmc7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBoZWFkID0gbmV3IFV0aWxzLkhlYWRVdGlscyhPcHRpb25zLnZ1ZSwgcmVuZGVyZWQubGF5b3V0LnN0eWxlKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXBwID0gbmV3IE1vZGVscy5BcHBDbGFzcyhWdWVDbGFzcywgdGVtcGxhdGUsIHNjcmlwdCwgaGVhZC50b1N0cmluZygpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYXBwKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiByZW5kZXJUb1N0cmVhbSBpcyB0aGUgbWFpbiBmdW5jdGlvbiB1c2VkIGJ5IHJlcy5yZW5kZXJWdWVcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gY29tcG9uZW50UGF0aCAtIGZ1bGwgcGF0aCB0byAudnVlIGNvbXBvbmVudFxuICAgICAqIEBwYXJhbSAge09iamVjdH0gZGF0YSAgICAgICAgICAtIGRhdGEgdG8gYmUgaW5zZXJ0ZWQgd2hlbiBnZW5lcmF0aW5nIHZ1ZSBjbGFzc1xuICAgICAqIEBwYXJhbSAge09iamVjdH0gdnVlT3B0aW9ucyAgICAtIHZ1ZSBvcHRpb25zIHRvIGJlIHVzZWQgd2hlbiBnZW5lcmF0aW5nIGhlYWRcbiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfSAgICAgICAgICAgICAgLSBQcm9taXNlIHJldHVybnMgYSBTdHJlYW1cbiAgICAgKi9cbiAgICByZW5kZXJUb1N0cmVhbShjb21wb25lbnRQYXRoOiBzdHJpbmcsIGRhdGE6IE9iamVjdCwgdnVlT3B0aW9uczogT2JqZWN0KTogUHJvbWlzZSA8IE9iamVjdCA+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMuY3JlYXRlQXBwT2JqZWN0KGNvbXBvbmVudFBhdGgsIGRhdGEsIHZ1ZU9wdGlvbnMpXG4gICAgICAgICAgICAgICAgLnRoZW4oYXBwID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdnVlU3RyZWFtID0gdnVlU2VydmVyUmVuZGVyZXIucmVuZGVyVG9TdHJlYW0oYXBwLlZ1ZUNsYXNzKTtcbiAgICAgICAgICAgICAgICAgICAgbGV0IGh0bWxTdHJlYW07XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGh0bWxTdHJpbmdTdGFydCA9IGAke2FwcC50ZW1wbGF0ZS5odG1sLnN0YXJ0fSR7YXBwLmhlYWR9JHthcHAudGVtcGxhdGUuYm9keS5zdGFydH0ke2FwcC50ZW1wbGF0ZS50ZW1wbGF0ZS5zdGFydH1gO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBodG1sU3RyaW5nRW5kID0gYCR7YXBwLnRlbXBsYXRlLnRlbXBsYXRlLmVuZH0ke2FwcC5zY3JpcHR9JHthcHAudGVtcGxhdGUuYm9keS5lbmR9JHthcHAudGVtcGxhdGUuaHRtbC5lbmR9YDtcblxuICAgICAgICAgICAgICAgICAgICBodG1sU3RyZWFtID0gbmV3IFV0aWxzLlN0cmVhbVV0aWxzKGh0bWxTdHJpbmdTdGFydCwgaHRtbFN0cmluZ0VuZCk7XG4gICAgICAgICAgICAgICAgICAgIGh0bWxTdHJlYW0gPSB2dWVTdHJlYW0ucGlwZShodG1sU3RyZWFtKTtcblxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGh0bWxTdHJlYW0pO1xuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEV4cHJlc3NWdWVSZW5kZXJlcjtcbiJdfQ==